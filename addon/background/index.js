(()=>{const e="Iv23liIE0QVUZFuIfOO9",t="https://lilianada.github.io/oauth-callback";chrome.runtime.onInstalled.addListener(()=>{console.log("Web Clipper extension installed"),chrome.storage.local.get(["githubToken"],e=>{console.log("Stored token:",e.githubToken?"Yes":"No")})}),chrome.tabs.onUpdated.addListener((o,r,a)=>{if(r.url&&r.url.startsWith(t)){const a=new URL(r.url),n=a.searchParams.get("code"),s=a.searchParams.get("state");n&&s&&async function(o,r){const{authState:a}=await chrome.storage.local.get(["authState"]);if(r===a)try{const{clientSecret:r}=await chrome.storage.local.get(["clientSecret"]);let a=r;if(!a&&(await new Promise(e=>{chrome.tabs.create({url:chrome.runtime.getURL("oauth-callback.html")+"?promptSecret=true"},async t=>{const o=async(r,n)=>{"GITHUB_CLIENT_SECRET"===r.type&&n.tab.id===t.id&&(a=r.secret,a&&await chrome.storage.local.set({clientSecret:a}),chrome.tabs.remove(t.id),chrome.runtime.onMessage.removeListener(o),e())};chrome.runtime.onMessage.addListener(o)})}),!a))throw new Error("Client secret is required for GitHub authentication");const n=await fetch("https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({client_id:e,client_secret:a,code:o,redirect_uri:t})}),s=await n.json();if(s.access_token)return await chrome.storage.local.set({githubToken:s.access_token}),console.log("GitHub authentication successful"),chrome.runtime.sendMessage({type:"GITHUB_AUTH_SUCCESS"}),!0;throw new Error("No access token in response")}catch(e){return console.error("Error exchanging code for token:",e),!1}else console.error("OAuth state mismatch")}(n,s).then(e=>{e&&chrome.tabs.remove(o)})}}),chrome.runtime.onMessage.addListener((o,r,a)=>"INITIATE_GITHUB_AUTH"===o.type?(async function(){const o=Math.random().toString(36).substring(2,15);await chrome.storage.local.set({authState:o});const r=`https://github.com/login/oauth/authorize?client_id=${e}&state=${o}&scope=repo&redirect_uri=${encodeURIComponent(t)}`;chrome.tabs.create({url:r})}().catch(e=>{console.error("Auth initiation error:",e),a({success:!1,error:e.message})}),!0):"SAVE_CLIP_TO_GITHUB"===o.type?(async function(e){try{const{githubToken:t}=await chrome.storage.local.get(["githubToken"]);if(!t)throw new Error("Not authenticated with GitHub");const o=`Content/webClips/${e.title.replace(/[^a-z0-9]/gi,"-").toLowerCase()}-${Date.now()}.md`,r=`---\ntitle: "${e.title}"\ntype: "${e.type}"\ntags: [${e.tags.map(e=>`"${e}"`).join(", ")}]\nurl: "${e.url}"\nsite: "${e.site}"\ndate: "${e.date}"\n---\n\n${e.markdown}\n`,a=btoa(unescape(encodeURIComponent(r))),n=await fetch(`https://api.github.com/repos/Lilianada/Lilyslab/contents/${o}`,{method:"PUT",headers:{Authorization:`token ${t}`,"Content-Type":"application/json"},body:JSON.stringify({message:`Add web clip: ${e.title}`,content:a,branch:"main"})});if(!n.ok){const e=await n.json();throw new Error(`GitHub API error: ${e.message}`)}return await n.json()}catch(e){throw console.error("Error saving to GitHub:",e),e}}(o.clip).then(e=>{a({success:!0,result:e})}).catch(e=>{a({success:!1,error:e.message})}),!0):"CHECK_GITHUB_AUTH"===o.type?(chrome.storage.local.get(["githubToken"],e=>{a({authenticated:!!e.githubToken})}),!0):void 0)})();